<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Avocado–Sunset Pixel Mapper: Deep Log View</title>
<style>
  body { font-family: system-ui, sans-serif; background: #fafafa; margin: 20px; }
  canvas { border: 1px solid #ccc; display: block; margin-bottom: 10px; }
  #log, #events {
    width: 650px; height: 200px; border: 1px solid #aaa;
    background: #fff; overflow-y: auto; font-family: monospace;
    padding: 6px; margin-bottom: 12px;
  }
  #events { background: #f9f9f9; }
  .event { margin: 2px 0; padding: 2px; border-bottom: 1px dotted #ccc; }
  .warn  { color: darkred; }
  .info  { color: #007; }
  .ok    { color: darkgreen; }
  button { padding: 6px 10px; }
</style>
</head>
<body>

<h2>Avocado–Sunset Pixel Mapper — Advanced Logging</h2>

<canvas id="c"></canvas>
<img id="source" src="avocado_sunset.png" style="display:none">

<div><button id="runBtn">Run Detailed Mapping</button></div>

<h3>Log Output (Function + Loop Details)</h3>
<div id="log"></div>

<h3>Event Timeline</h3>
<div id="events"></div>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
const img = document.getElementById("source");
const logEl = document.getElementById("log");
const eventsEl = document.getElementById("events");
const runBtn = document.getElementById("runBtn");

// === Logging helpers ===
function log(msg, cls="") {
  const line = document.createElement("div");
  if (cls) line.classList.add(cls);
  line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  logEl.appendChild(line);
  logEl.scrollTop = logEl.scrollHeight;
}
function event(msg, cls="event") {
  const line = document.createElement("div");
  line.className = cls;
  line.textContent = msg;
  eventsEl.appendChild(line);
  eventsEl.scrollTop = eventsEl.scrollHeight;
}

function isAvocadoGreen(r,g,b) {
  return (g > 70 && g > r + 10 && g > b + 10 && r < 120 && b < 120);
}

function mapPixelsDetailed() {
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;
  const w = canvas.width;
  const h = canvas.height;
  const totalPixels = w * h;

  let mapped = 0, greenCount = 0, otherCount = 0;
  const start = performance.now();
  log("Beginning pixel mapping at " + start.toFixed(2) + " ms.", "info");
  event("Process started.");

  // Outer Y loop
  for (let y = 0; y < h; y++) {
    log(`Row y=${y} start`, "info");

    // Inner X loop
    for (let x = 0; x < w; x++) {
      const idx = (y * w + x) * 4;
      let r = data[idx];
      let g = data[idx + 1];
      let b = data[idx + 2];
      let a = data[idx + 3];
      mapped++;

      const avocado = isAvocadoGreen(r,g,b);
      if (avocado) {
        greenCount++;
        data[idx]     = 60;
        data[idx + 1] = 70;
        data[idx + 2] = 20;
        data[idx + 3] = a;
      } else {
        otherCount++;
      }

      // For the first few pixels, log full details
      if (y < 3 && x < 5) {
        log(`(x=${x},y=${y}) RGBA=(${r},${g},${b},${a}) → (${data[idx]},${data[idx+1]},${data[idx+2]},${data[idx+3]}) ${avocado?"[green→darkened]":"[unchanged]"}`);
      }

      if (mapped % 20000 === 0) {
        const pct = ((mapped / totalPixels) * 100).toFixed(1);
        event(`Checkpoint: processed ${mapped}/${totalPixels} (${pct}%)`);
      }
    }

    // Log row summary every 20 rows
    if (y % 20 === 0) {
      log(`Row y=${y} complete (so far ${mapped} pixels)`);
    }
  }

  const end = performance.now();
  ctx.putImageData(imageData, 0, 0);
  const duration = (end - start).toFixed(2);

  log(`Mapping complete in ${duration} ms.`, "ok");
  event("Mapping finished successfully.");
  event(`Pixels processed: ${mapped}`);
  event(`Avocado-green pixels: ${greenCount}`);
  event(`Other pixels: ${otherCount}`);
}

img.onload = () => {
  canvas.width = img.width;
  canvas.height = img.height;
  ctx.drawImage(img, 0, 0);
  log("Image loaded successfully.");
  event("Image ready for mapping.");
};

runBtn.onclick = () => {
  logEl.innerHTML = "";
  eventsEl.innerHTML = "";
  log("Resetting canvas and logs...");
  ctx.drawImage(img, 0, 0);
  mapPixelsDetailed();
};
</script>
</body>
</html>
